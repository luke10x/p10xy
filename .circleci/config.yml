version: 2.1
orbs:
  node: circleci/node@3.0.0
jobs:
  p10xy-npm-package:
    # docker:
    #   - image: 'cimg/base:stable'
    #     # auth:
    #     #   username: mydockerhub-user
    #     #   password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
    executor:
      name: node/default
    working_directory: agent
    steps:
      - checkout:
          path: ~/project
      - run:
          name: "Show versions"
          command: |
            published_version=$(npm view p10p10p10 version)
            this_version=$(node -p -e "require('./package.json').version")
            echo "ðŸŒ latest published version: $published_version"
            echo "ðŸš§ package version of this build: $this_version"
            if [ "$published_version" = "$this_version" ]; then
              echo "ðŸ¦˜ skip NPM Publish, because this version is published"
              return 127
            else
              echo "ðŸ±â€ðŸ Update NPM, yes please!"
            fi
      - run:
          when: on_fail
          name: "Skip publishing"
          command: |
            echo "â›” Stop this job without publishing"
            circleci-agent step halt
      - run:
          name: "Publish"
          command: |
            echo "ðŸš€ Publishing NPM package!"
            echo "//registry.npmjs.org/:_authToken=$NPM_AUTH_TOKEN" > ~/.npmrc
            npm publish

workflows:
  commit:
    jobs:
      - node/test:
          app-dir: agent
      - p10xy-npm-package:
          requires:
            - node/test
